# 実装計画（タスク分解・優先度・受け入れ基準）

## フェーズ構成（優先度: 高 → 低）

1. **P0: 基盤整備 & 仕様固定**
2. **P1: 抽出/前処理（/extract）**
3. **P2: Claude Code連携（/outline, /generate, /regenerate, /repair）**
4. **P3: SSEフレーム（バックエンド→フロント）**
5. **P4: フロントUI（ウィザード、エディタ、再生成モーダル）**
6. **P5: Notion連携（/to-notion + プレビュー）**
7. **P6: テスト整備（pytest/E2E/CI）**
8. **P7: Docker運用（frontend/backend/proxy）**
9. **P8: ドキュメント最終化**

---

## P0: 基盤整備 & 仕様固定（優先度: 高）

**タスク**

- リポジトリ初期化（frontend/ backend/ proxy/ .claude/commands/）
- `.env.example` 作成（NOTION_API_KEY, NOTION_DATABASE_ID, CLAUDE_BIN, REQUEST_TIMEOUT_SEC 等）
- 共通エラー定義（付録の E100〜E900）
- 出力一時ディレクトリの規約（`/tmp/notion-article-creator/{uuid}/`）

**受け入れ基準**

- `make check` もしくは簡易スクリプトで lint/format が通る
- ルート README に起動・.env・構成が明記

---

## P1: 抽出/前処理（/extract）（優先度: 高）

**タスク**

- Trafilatura + （失敗時）BeautifulSoup の実装
- 正規化（軽量Markdown: H2/H3 以外のノイズ最小化）
- 入力サイズバリデーション（MAX_FILE_SIZE_MB / MAX_TOTAL_UPLOAD_MB）

**API**

- `POST /extract`
  入力: URL[], ファイル[]
  出力: `[{ source, content_md, length }]`

**受け入れ基準**

- 無効URLで E100 を返す
- 代表的な技術ブログURLで本文抽出が成功し、ノイズが最小化されている

---

## P2: Claude Code連携（/outline, /generate, /regenerate, /repair）（優先度: 高）

**タスク**

- `.claude/commands/outline.md` / `generate.md` / `regenerate.md` / `repair.md` の雛形作成
- バックエンドから `subprocess` で `claude -p "<command> [args]"` を実行
- 出力を `/tmp/.../output/*.out` に追記しつつ取得

**受け入れ基準**

- `/outline` で有効なアウトライン JSON（outlineVersion="1.0"）が返る
- `/generate` で H2/H3 + `<!-- id: ... -->` を満たす Markdown が返る
- 検証失敗時に `/repair` が自動実行される

---

## P3: SSEフレーム（優先度: 高）

**タスク**

- SSEイベント: `progress / partial / complete / error`
- ファイル追記を tail しながら `partial` 送信
- タイムアウト/リトライ（REQUEST_TIMEOUT_SEC / RETRY_MAX_ATTEMPTS）

**受け入れ基準**

- 長文生成で `partial` が逐次 UI に反映される
- タイムアウト時に E900 が通知され再試行が走る

---

## P4: フロントUI（優先度: 中〜高）

**タスク**

- ステップ式ウィザード（Step1/3/4/5）
- アウトラインエディタ（react-markdown系、H2/H3編集、D&D並び替え、インライン編集、目安文字数メモ）
- 本文エディタ（プレビュー＋再生成モーダル：追加指示欄、scope選択）
- Markdown保存（`YYYYMMDD-title-slug.md`）

**受け入れ基準**

- 仕様どおりの編集・並べ替え・再生成がUIから操作できる
- 失敗時トースト詳細に stderr 末尾が確認できる

---

## P5: Notion連携（優先度: 中）

**タスク**

- Notion DB へのページ作成（Name/Category/Keywords）
- Notion形式プレビュー（送信直前）
- 値未登録時のカテゴリ/キーワード自動作成
- 送信失敗時の再送

**受け入れ基準**

- 正しい API キーでページが作成される
- 無効キー時に E500（自動リトライ後に再送ボタン）

---

## P6: テスト整備（優先度: 中）

**タスク**

- pytest（ユニット）: extract / outline / generate / regenerate / repair
- Playwright（E2E）: 入力→送信まで通貫、SSE確認
- GitHub Actions（CI）: ユニット＋E2E の実行

**受け入れ基準**

- 主要 Happy/Unhappy パスがテストで網羅され、再現性がある
- PR時に CI が自動実行される

---

## P7: Docker運用（優先度: 低〜中）

**タスク**

- `frontend`, `backend`, `proxy` の Compose
- Nginx: SSE/CORS/SSL
- `.env` を `env_file` で注入

**受け入れ基準**

- `docker compose up -d --build` で起動し、ブラウザから一連の動作が確認できる

---

## P8: ドキュメント最終化（優先度: 低）

**タスク**

- 仕様書（最終版）同梱
- 運用ガイド/カスタムコマンド一覧/付録（エラー・SSE・検証ルール）
- 図（Mermaid）レンダリング確認

**受け入れ基準**

- README から迷わず起動・操作できる

---

## モジュール別タスク明細（バックログ形式）

### backend/

- [ ] `app/main.py`：FastAPI 起動、CORS/SSE 設定
- [ ] `app/routes/extract.py`：抽出・正規化、E100
- [ ] `app/routes/outline.py`：SSEストリーム、claude呼び出し、JSON検証、E200/E201
- [ ] `app/routes/generate.py`：SSEストリーム、Markdown検証、E300
- [ ] `app/routes/regenerate.py`：scope/target 検証、置換ポリシー、E301
- [ ] `app/routes/to_notion.py`：ページ作成、E500/E501、再送
- [ ] `app/core/validator.py`：JSON/Markdown 検証
- [ ] `app/core/claude.py`：`subprocess` ラッパ、timeout/retry、stderr 収集
- [ ] `app/core/sse.py`：イベントエンコーディング、心拍（keep-alive）
- [ ] `tests/unit/*`：pytest

### frontend/

- [ ] ルーティング/ウィザード（Steps）
- [ ] 入力フォーム（カテゴリ/キーワード補完）
- [ ] アウトラインエディタ（H2/H3、D&D、インライン編集）
- [ ] 本文エディタ（プレビュー、再生成モーダル）
- [ ] SSE クライアント（progress/partial/complete/error）
- [ ] Notion送信ダイアログ＋プレビュー
- [ ] Playwright E2E

### proxy/

- [ ] Nginx conf（SSE: `proxy_buffering off;`, CORS）
- [ ] SSL/TLS 終端（任意）

### .claude/commands/

- [ ] outline.md（入出力契約を満たす）
- [ ] generate.md（H2/H3 + ID コメント）
- [ ] regenerate.md（scope/target対応）
- [ ] repair.md（説明禁止・成果物のみ）

---

## インターフェース契約（I/O スキーマ簡易）

### /outline（SSE）

- **request**

  ```json
  {
    "sources": [{"source":"url-or-file", "content_md":"..."}],
    "style": "A|B|C",
    "policy": { "audience":"...", "goal":"...", "constraints":{...} }
  }
  ```

- **event: partial**（例）

  ```json
  {"type":"partial","data":"{\"outlineVersion\":\"1.0\",\"nodes\":[...]} (chunk)"}
  ```

### /generate（SSE）

- **request**

  ```json
  {
    "outline": {"outlineVersion":"1.0","nodes":[...]},
    "sources": [...],
    "style":"A|B|C",
    "policy": {...}
  }
  ```

- **event: partial**: Markdown 断片

### /to-notion（sync）

- **request**

  ```json
  {
    "title":"...",
    "category":"...",
    "keywords":["k1","k2"],
    "markdown":"..."
  }
  ```

- **response**

  ```json
  {"status":"success","data":{"pageUrl":"https://www.notion.so/..."}} 
  ```

---

## 置換ポリシー（/regenerate）

- `REGEN_SCOPE=section|paragraph` の場合、対象ノード `<!-- id: X -->` で囲まれる **最小セクション領域のみ** を置換
- 置換はアンカー（見出し行）から次見出し直前まで
- 先頭・末尾の空行を1行に正規化、フェンス閉包を再検証

---

## リスクと対策

- **CLI不安定/更新**: CLAUDE_BIN バージョン固定、`--version` チェック
- **SSE途切れ**: Nginx `proxy_read_timeout` 調整、keep-alive 送信
- **抽出精度**: Trafilatura 設定の調整、サイト別ヒューリスティクス拡張の余地
- **Notion API 制限**: レートリミットに注意（指数バックオフと idempotent 再送）
- **大入力**: サイズ制限とチャンク戦略（章6に準拠）

---

## 完了の定義（DoD）

- 仕様1〜19章の要件を満たし、付録の検証・エラー規約に準拠
- 主要 Happy/Unhappy パスの自動テストがCIで成功
- Docker Compose で起動し、ウィザード完走（抽出→生成→Notion送信）が実機確認できる
- README と運用ガイドを読めば迷わず利用開始できる

---

## 最初の一歩（推奨実装順）

1. P0 基盤 → P1 抽出 → P3 SSE 骨格
2. P2 Claude連携（outline→generate→repair→regenerate の順）
3. P4 フロント UI 接続・再生成モーダル
4. P5 Notion送信＋プレビュー
5. P6〜P7 テストと Docker 仕上げ → P8 ドキュメント締め

---
