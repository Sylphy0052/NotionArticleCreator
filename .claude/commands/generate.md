# /generate — 本文生成コマンド
>
> **目的**：確定アウトライン（JSON v1.0）と素材Markdownから、H2/H3のみで構成された**本文Markdown**を生成する。
> **出力**：Markdown **本文のみ**（前置き・後書き・説明・コードフェンスや余計な文字を一切混在させない）。

## 使用サブエージェント

- **DraftingAgent**（`.claude/agents/drafting.md`）
  - このコマンドの主担当。アウトライン順序・階層に忠実に本文を生成し、各見出し末尾へ `<!-- id: NODE_ID -->` を必ず付与する。STYLE/追加指示を反映し、整形式Markdownのみを出力する。

## 入力（引数仕様）

- `--var STYLE`: `"A" | "B" | "C"`
  - A: 技術ブログ風（簡潔・実践重視）
  - B: 解説記事風（序論→背景→手順→考察→まとめ）
  - C: ノート風（短セクション多数・要点中心）
- `--var OUTLINE_JSON_FILE`: **必須**。`{"outlineVersion":"1.0","nodes":[...]}` 形式のアウトラインJSON（ファイルパス）
- `--var EXTRA_INSTRUCTIONS`（任意）: 追加指示（例：`箇条書きを増やす`、`導入を短く` など）
- `--input-file`: **必須**。抽出・正規化済みの素材Markdown

## バリデーション（実行前）

- `OUTLINE_JSON_FILE` の存在とJSON整合（`outlineVersion="1.0"`, `level∈{2,3}`, `id:UUID`, `order` 連番, `parentId` 整合）を確認。
- `STYLE` が A/B/C のいずれかであること。
- 入力Markdownが非空であること。

## 実行手順（フロー）

1. **DraftingAgent** を呼び出し、以下の制約で生成を指示：
   - 見出しは **H2/H3のみ**（H1禁止）。
   - 各見出し行の末尾に **`<!-- id: NODE_ID -->`** を厳密付与（アウトラインのIDと一致）。
   - アウトラインの順序・階層に忠実に本文を構成。
   - コードブロックは言語タグを**自動推定**し、未推定時は `text`（または `plaintext`）相当。
   - 余計な前置き・後書き・説明文・メタコメントは禁止。
   - `EXTRA_INSTRUCTIONS` があれば必ず反映。
2. 生成結果は **Markdown本文のみ** を標準出力へ返す（余計な文字やコードフェンス禁止、未閉包フェンス禁止）。

## 出力（契約）

```markdown
## セクション見出し <!-- id: 11111111-1111-4111-8111-111111111111 -->
本文…

### 小見出し <!-- id: 22222222-2222-4222-8222-222222222222 -->
本文…
```

- H2/H3 のみを使用。
- 各見出し末尾の `id` はアウトラインのUUIDと**厳密一致**。
- コードブロックは**必ず閉じる**。表は最小仕様（複雑な結合を避ける）。

## 呼び出し例（バックエンド）

```bash
claude -p "/generate \
  --var STYLE=B \
  --var OUTLINE_JSON_FILE=/tmp/outline.json \
  --var EXTRA_INSTRUCTIONS='導入を2段落以内に' \
  --input-file /tmp/sources.md"
```

## 失敗時の扱い（推奨）

- Markdown検証（H1混入、未閉包フェンス、`id` 欠落/不一致）でNGの場合、バックエンド側で `/repair` を自動実行（`TARGET=MARKDOWN`）。
- 修復不能時はエラー通知（E300）として扱い、再実行またはアウトライン修正を促す。
