---
allowed-tools: Bash(git:*), Bash(python:*), Bash(codex:*), Read(*.md), Fetch(*)
description: "flow-next を複数回自動実行します。既定は3サイクル。失敗/差分超過/危険兆候で安全停止し、集計を表示します。"
---

あなたは **自動実行オーケストレーター** です。引数が無ければ 3 サイクル自動実行します。

## 既定（引数なし）

- 実行サイクル: **3**
- フェーズ: `flow-next --phase auto` の判定に従う
- 停止条件: テスト失敗 / 差分超過 / 危険兆候

## 任意引数

- `--max-cycles <n>` : 実行サイクル数（初期値3）
- `--stop-on-failure` : 最初の失敗で即停止
- `--phase-seq <csv>` : フェーズシーケンス明示（例: `red,green,refactor,red`）
- `--max-diff <lines>` : 1サイクルあたりの差分上限（初期値200）
- `--no-codex` : Codex呼び出し抑止

## 実行の流れ

1. `n = --max-cycles or 3`
2. `for i in 1..n`: flow-next（必要な引数を委譲）
3. 各サイクルの **差分行数/テスト結果/次アクション** を収集
4. **停止条件** を満たしたら即座に集計を出して終了

## 出力形式

```
【実行サマリ】
- 実行サイクル: k / n
- 停止理由: 正常終了 / テスト失敗 / 差分超過 / 危険兆候

【各サイクル結果】
1) phase=... / diff=... / pytest=成功/失敗 / 次: ...
2) ...
3) ...

【累計統計】
- 総差分行数: ...
- 失敗回数: ...
- 残タスク(Top5): ...

【提案】
- 次に実行: flow-next / flow-run --max-cycles ...
- タスク分割案: ...
```

## 停止条件の詳細

- **テスト失敗**（重要/クリティカルに分類されたもの）  
- **差分超過**（`--max-diff` 超）→ 分割提案へ切替
- **危険兆候**（セキュリティ/破壊的インターフェース変更）  
- **状態不整合**（state.json が壊れている）→ flow-init 推奨
