# CLAUDE.md — Claude Code 運用（レビュア/オーケストレータ）

Claude Code の主担当は**レビューと統合**です。Codexの実装成果に対して差分レビューを行い、安全な進行を保証します。

## カスタムコマンド（flow 系）

> 引数なしで連続運用できるのが原則。必要に応じてフェーズや上限をフラグで絞り込み可能。

### `flow-init`

- 目的: 初期セットアップ（インデックス、初期方針の読込）
- 入出力:
  - 入: なし（必要ならプロジェクトルート自動検出）
  - 出: `.claude/flow/state.json` の初期化、既存ドキュメントの要約
    - `docs/spec.md` ← **Claude専用の仕様書**
  - これを読み込み、初期状態に「仕様と運用の共通理解」を確立する

### `flow-status`

- 目的: 現在のフェーズ・タスク・テスト結果等の**サマリ**を表示
- 出力例: phase, current_task, next_tasks(5), last_diff, last_test_result, warnings

### `flow-next`（詳細フロー）

1. **状態読込**（キューから次タスクを取得。なければTriagerに再優先度付けを依頼）
2. **レビュー視点の前提確認**（受け入れ基準/TDDの未備品を点検）
3. **Codexへ実装要求**を発行（下記「Codex連携」参照）
   - 要求内容: *目的/受け入れ基準/境界条件/影響範囲/最小パッチ/先にテスト*
4. **差分レビュー**（Codex出力のdiffをClaudeとCodex両方が確認）
   - 設計意図の整合、命名/副作用/エラー処理、性能・トランザクション境界
   - **テスト先行か**（失敗→実装→パス）を厳守
5. **フィードバック**（具体的修正点を箇条書きで返却）
6. **合格なら統合計画**（マージ手順/リリースノート/移行）を提示し `flow-run` へ

### `flow-run`（詳細フロー）

1. **安全チェック**：main保護、CI必須、環境変数/シークレット検証
2. **テスト実行**：TDDに基づき新規/既存テストを全走査（失敗なら停止→`flow-next`へ戻す）
3. **マージ準備**：コンフリクト解消方針、バージョン/CHANGELOG更新案を生成
4. **適用プラン提示**：実施コマンド・ロールバック手順（git revert/タグ）を明示
5. **（人間の承認を前提に）適用** or **保留**

### `flow-reset`

- 目的: 失敗の巻き戻し、状態のクリーンアップ
- 手順: ワークツリーを安全に復元、未コミット変更を退避、stateを再初期化

## サブエージェント（Claude側）

- **Reviewer**: Codexと協力して差分レビュー、TDD順守チェック
- **Integrator**: 統合/マージ戦略の提示
- **Doc Linter**: `docs/spec.md` の差分整合性、リンク妥当性の検査
- **Risk Auditor**: 例外・リソースリーク・レース検出の観点でレビュー

## Codex との連携指示（Claude視点）

- 依頼テンプレ:
  - 「**先にテスト** → 最小パッチ → テストパス → 追加リファクタは別PR」
  - 要求フォーマット: *goal, constraints, acceptance_criteria, risks, tasks(≤2h), test_plan, patch_diff*
- 受領物に必須:
  - **差分（unified diff）**
  - **テストコード**（失敗→パスの証跡）
  - **ロールバックプラン**
